name: Generate Contribution Snake

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©UTCæ—¶é—´0ç‚¹æ›´æ–°ä¸€æ¬¡
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      # ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆè›‡å½¢å›¾
      - name: Generate snake.svg
        id: snake-gen
        uses: Platane/snk@v2
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: assets/github-snake.svg?theme=dark
          config: |
            {
              "size": 12,
              "colors": {
                "background": "#0d1117",
                "grid": "#161b22",
                "snake": "#3fb950"
              }
            }
        
      # ç¬¬äºŒæ­¥ï¼šæ£€å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: main-repo
          
      # ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæˆ–æ›´æ–°è›‡å½¢å›¾æ–‡ä»¶
      - name: Create/Update snake file
        run: |
          # ç¡®ä¿assetsç›®å½•å­˜åœ¨
          mkdir -p main-repo/assets
          
          # ç§»åŠ¨ç”Ÿæˆçš„è›‡å½¢å›¾åˆ°ä»“åº“ç›®å½•
          find . -name "github-snake.svg" -exec mv {} main-repo/assets \;
          
          # åˆ›å»ºæäº¤æ—¥å¿—
          echo "ğŸ”„ Last update: $(date)" > update.log
          
      # ç¬¬å››æ­¥ï¼šæ›´æ–°READMEï¼ˆç‹¬ç«‹æ­¥éª¤ï¼‰
      - name: Update README with snake
        run: |
          cd main-repo
          
          # ç¡®ä¿READMEä¸­å­˜åœ¨é”šç‚¹
          if ! grep -q "<!-- START_SNAKE -->" README.md; then
            echo -e "\n<!-- START_SNAKE -->\n<!-- END_SNAKE -->" >> README.md
          fi
          
          # æ›´æ–°è›‡å½¢å›¾éƒ¨åˆ†
          sed -i '/<!-- START_SNAKE -->/,/<!-- END_SNAKE -->/{//!d}' README.md
          sed -i '/<!-- START_SNAKE -->/a ![GitHub Contribution Snake](assets/github-snake.svg "My contribution activity")' README.md
          
          # æ·»åŠ çŠ¶æ€æ—¥å¿—
          echo -e "\nğŸ Last updated: $(date)" >> update.log
          
      # ç¬¬äº”æ­¥ï¼šæäº¤æ›´æ”¹ï¼ˆä½¿ç”¨ä¸“é—¨çš„æäº¤åŠ¨ä½œï¼‰
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          repository: main-repo
          branch: main
          commit_message: "Update GitHub contribution snake - $(date)"
          file_pattern: |
            README.md
            assets/github-snake.svg
            update.log
            
  # å¯é€‰çš„ç»“æŸé€šçŸ¥æ­¥éª¤
  notify:
    needs: generate
    runs-on: ubuntu-latest
    steps:
      - name: Show completion message
        run: |
          echo "âœ… GitHub contribution snake has been successfully updated!"
          echo "â¡ï¸ Updated at: $(date)"

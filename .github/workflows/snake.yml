name: Generate Contribution Snake

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©UTCæ—¶é—´0ç‚¹æ›´æ–°ä¸€æ¬¡
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: main-repo
          
      # 2. ç”Ÿæˆç®€å•è›‡å½¢å›¾ï¼ˆé¿å…å¤æ‚å‚æ•°ï¼‰
      - name: Generate basic snake
        id: snake-gen
        uses: Platane/snk@v2
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: snake-basic.svg
          
      # 3. ç”Ÿæˆè‡ªå®šä¹‰è›‡å½¢å›¾ï¼ˆä½¿ç”¨å•ä¸€æŸ¥è¯¢å‚æ•°ï¼‰
      - name: Generate custom snake
        id: custom-snake
        run: |
          # æ„å»ºå®‰å…¨çš„è‡ªå®šä¹‰å‚æ•°
          BG_COLOR="0d1117"
          GRID_COLOR="161b22"
          SNAKE_COLOR="3fb950"
          
          # é€šè¿‡curlç”Ÿæˆè›‡å½¢å›¾
          curl "https://contrib.rocks/image?repo=${{ github.repository_owner }}/${{ github.repository_owner }}&palette=$BG_COLOR-$GRID_COLOR-$SNAKE_COLOR" -o custom-snake.svg
          
          # ä¿å­˜è·¯å¾„ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "SNAKE_PATH=custom-snake.svg" >> $GITHUB_ENV
          
      # 4. ç§»åŠ¨è›‡å½¢å›¾åˆ°ä»“åº“
      - name: Move snakes to repository
        run: |
          # ç¡®ä¿assetsç›®å½•å­˜åœ¨
          mkdir -p main-repo/assets
          
          # ç§»åŠ¨ä¸¤ç§è›‡å½¢å›¾
          mv snake-basic.svg main-repo/assets/snake-basic.svg
          mv ${{ env.SNAKE_PATH }} main-repo/assets/snake-custom.svg
          
      # 5. å®‰å…¨æ›´æ–°READMEä¸­çš„è›‡å½¢å›¾éƒ¨åˆ†
      - name: Update README with snake
        run: |
          cd main-repo
          
          # ç¡®ä¿READMEä¸­å­˜åœ¨é”šç‚¹
          if ! grep -q "<!-- START_SNAKE -->" README.md; then
            echo -e "\n<!-- START_SNAKE -->\n<!-- END_SNAKE -->" >> README.md
          fi
          
          # åˆ é™¤æ—§å†…å®¹å¹¶æ·»åŠ æ–°å†…å®¹
          if grep -q "<!-- START_SNAKE -->" README.md; then
            # è·å–é”šç‚¹è¡Œå·
            start_line=$(grep -n "<!-- START_SNAKE -->" README.md | cut -d: -f1)
            end_line=$(grep -n "<!-- END_SNAKE -->" README.md | cut -d: -f1)
            
            # åˆ é™¤æ—§å†…å®¹
            if [ -n "$start_line" ] && [ -n "$end_line" ] && [ $end_line -gt $start_line ]; then
              sed -i "${start_line},${end_line}d" README.md
            fi
          fi
          
          # æ·»åŠ æ–°å†…å®¹
          echo "<!-- START_SNAKE -->" >> README.md
          echo "## ğŸ My Contribution Activity" >> README.md
          echo "![Basic Snake](assets/snake-basic.svg)" >> README.md
          echo "![Custom Snake](assets/snake-custom.svg)" >> README.md
          echo "<!-- END_SNAKE -->" >> README.md
          
      # 6. æäº¤æ›´æ”¹
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          repository: main-repo
          branch: main
          commit_message: "Update GitHub snake - $(date +'%Y-%m-%d')"
          file_pattern: |
            README.md
            assets/snake-*

  # å¯é€‰ï¼šæˆåŠŸåé€šçŸ¥
  notify:
    needs: generate
    runs-on: ubuntu-latest
    if: ${{ success() }}
    steps:
      - name: Success notification
        run: echo "Snake generated successfully at $(date)" >> $GITHUB_STEP_SUMMARY

name: Generate Contribution Snake

on:
  schedule:
    - cron: "0 0 * * *"  # 每天UTC时间0点更新一次
  workflow_dispatch:      # 允许手动触发

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
      # 第一步：生成蛇形图
      - name: Generate snake.svg
        id: snake-gen
        uses: Platane/snk@v2
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: assets/github-snake.svg?theme=dark
          config: |
            {
              "size": 12,
              "colors": {
                "background": "#0d1117",
                "grid": "#161b22",
                "snake": "#3fb950"
              }
            }
        
      # 第二步：检出仓库
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          path: main-repo
          
      # 第三步：创建或更新蛇形图文件
      - name: Create/Update snake file
        run: |
          # 确保assets目录存在
          mkdir -p main-repo/assets
          
          # 移动生成的蛇形图到仓库目录
          find . -name "github-snake.svg" -exec mv {} main-repo/assets \;
          
          # 创建提交日志
          echo "🔄 Last update: $(date)" > update.log
          
      # 第四步：更新README（独立步骤）
      - name: Update README with snake
        run: |
          cd main-repo
          
          # 确保README中存在锚点
          if ! grep -q "<!-- START_SNAKE -->" README.md; then
            echo -e "\n<!-- START_SNAKE -->\n<!-- END_SNAKE -->" >> README.md
          fi
          
          # 更新蛇形图部分
          sed -i '/<!-- START_SNAKE -->/,/<!-- END_SNAKE -->/{//!d}' README.md
          sed -i '/<!-- START_SNAKE -->/a ![GitHub Contribution Snake](assets/github-snake.svg "My contribution activity")' README.md
          
          # 添加状态日志
          echo -e "\n🐍 Last updated: $(date)" >> update.log
          
      # 第五步：提交更改（使用专门的提交动作）
      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          repository: main-repo
          branch: main
          commit_message: "Update GitHub contribution snake - $(date)"
          file_pattern: |
            README.md
            assets/github-snake.svg
            update.log
            
  # 可选的结束通知步骤
  notify:
    needs: generate
    runs-on: ubuntu-latest
    steps:
      - name: Show completion message
        run: |
          echo "✅ GitHub contribution snake has been successfully updated!"
          echo "➡️ Updated at: $(date)"
